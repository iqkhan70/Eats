@page "/"
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager NavigationManager
@inject HttpClient Http

<PageTitle>TraditionalEats - Traditional Food Delivery</PageTitle>

<RadzenStack Gap="1.5rem" Style="padding: 1rem; width: 100%; max-width: 100vw; box-sizing: border-box;" Class="page-container">
    <RadzenText TextStyle="TextStyle.H1">Welcome to TraditionalEats</RadzenText>
    <RadzenText TextStyle="TextStyle.Body1">
        Discover authentic traditional food from local restaurants, delivered to your door.
    </RadzenText>
    
    <RadzenCard Style="margin-top: 1rem;">
        <RadzenStack Gap="1rem">
            <RadzenText TextStyle="TextStyle.H3">Find Restaurants Near You</RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.End" Class="search-container" Style="position: relative;">
                <RadzenFormField Text="Enter your location" class="w-100" Style="flex: 1; position: relative;">
                    <RadzenTextBox @ref="searchTextBox" 
                                   @bind-value="@searchLocation" 
                                   Placeholder="Enter your address or location"
                                   @oninput="@HandleInput"
                                   @onkeypress="@HandleKeyPress"
                                   Style="width: 100%;" />
                    @if (showSuggestions && suggestions.Any())
                    {
                        <div class="suggestions-dropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            @foreach (var suggestion in suggestions)
                            {
                                <div class="suggestion-item" 
                                     style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; @(hoveredSuggestion == suggestion ? "background-color: #f5f5f5;" : "")" 
                                     @onclick="@(() => SelectSuggestion(suggestion))"
                                     @onmouseover="@(() => hoveredSuggestion = suggestion)"
                                     @onmouseout="@(() => hoveredSuggestion = null)">
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                        <RadzenIcon Icon="location_on" Style="font-size: 16px; color: #666;" />
                                        <RadzenText TextStyle="TextStyle.Body2">@suggestion</RadzenText>
                                    </RadzenStack>
                                </div>
                            }
                        </div>
                    }
                </RadzenFormField>
                <RadzenButton Text="Search" Icon="search" Click="@SearchRestaurants" Variant="Variant.Flat" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    <RadzenCard Style="margin-top: 1rem; width: 100%; max-width: 100%;" Class="categories-container">
        <RadzenStack Gap="1rem">
            <RadzenText TextStyle="TextStyle.H3">Popular Categories</RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" Style="flex-wrap: wrap; width: 100%;" Class="categories-stack">
                @foreach (var category in displayedCategories)
                {
                    <RadzenCard Style="cursor: pointer;" Class="category-card" Click="@(() => NavigateToCategory(category))">
                        <RadzenStack Gap="0.5rem" Style="align-items: center; text-align: center;">
                            <RadzenIcon Icon="@category.Icon" Style="font-size: 48px; color: var(--rz-primary);" />
                            <RadzenText TextStyle="TextStyle.Body1">@category.Name</RadzenText>
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>
            @if (categories.Count > initialCategoryCount)
            {
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Style="margin-top: 0.5rem;">
                    <RadzenButton 
                        Text="@(showAllCategories ? "Show Less" : $"Show All ({categories.Count})")" 
                        Icon="@(showAllCategories ? "expand_less" : "expand_more")"
                        Click="@ToggleCategories" 
                        Variant="Variant.Flat" 
                        Size="ButtonSize.Small" />
                </RadzenStack>
            }
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private RadzenTextBox? searchTextBox;
    private string searchLocation = string.Empty;
    private List<string> suggestions = new();
    private bool showSuggestions = false;
    private string? hoveredSuggestion = null;
    private bool showAllCategories = false;
    private const int initialCategoryCount = 6;
    private System.Threading.CancellationTokenSource? _debounceCts;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && searchTextBox != null)
        {
            await searchTextBox.FocusAsync();
        }
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? string.Empty;
        searchLocation = value;
        await LoadSuggestions(value);
    }

    private async Task LoadSuggestions(string query)
    {
        if (string.IsNullOrWhiteSpace(query) || query.Length < 2)
        {
            suggestions = new List<string>();
            showSuggestions = false;
            StateHasChanged();
            return;
        }

        // Debounce the API call
        _debounceCts?.Cancel();
        _debounceCts = new System.Threading.CancellationTokenSource();
        
        try
        {
            await Task.Delay(300, _debounceCts.Token); // Wait 300ms after user stops typing
            
            var response = await Http.GetFromJsonAsync<List<string>>(
                $"WebBff/search-suggestions?query={Uri.EscapeDataString(query)}&maxResults=10",
                _debounceCts.Token);
            
            suggestions = response ?? new List<string>();
            showSuggestions = suggestions.Any();
            StateHasChanged();
        }
        catch (System.Threading.Tasks.TaskCanceledException)
        {
            // Debounce cancelled, ignore
        }
        catch (Exception)
        {
            suggestions = new List<string>();
            showSuggestions = false;
            StateHasChanged();
        }
    }

    private void SelectSuggestion(string suggestion)
    {
        searchLocation = suggestion;
        showSuggestions = false;
        suggestions = new List<string>();
        StateHasChanged();
    }

    private List<CategoryItem> categories = new()
    {
        new CategoryItem { Name = "Traditional", Icon = "restaurant" },
        new CategoryItem { Name = "Fast Food", Icon = "fastfood" },
        new CategoryItem { Name = "Desserts", Icon = "cake" },
        new CategoryItem { Name = "Beverages", Icon = "local_drink" },
        new CategoryItem { Name = "Vegetarian", Icon = "eco" },
        new CategoryItem { Name = "Vegan", Icon = "spa" },
        new CategoryItem { Name = "Seafood", Icon = "set_meal" },
        new CategoryItem { Name = "BBQ", Icon = "outdoor_grill" },
        new CategoryItem { Name = "Italian", Icon = "dinner_dining" },
        new CategoryItem { Name = "Asian", Icon = "ramen_dining" }
    };

    private List<CategoryItem> displayedCategories => showAllCategories 
        ? categories 
        : categories.Take(initialCategoryCount).ToList();

        private void SearchRestaurants()
        {
            if (!string.IsNullOrEmpty(searchLocation))
            {
                NavigationManager.NavigateTo($"/restaurants?location={Uri.EscapeDataString(searchLocation)}");
            }
            else
            {
                NavigationManager.NavigateTo("/restaurants");
            }
        }

        private void HandleKeyPress(KeyboardEventArgs e)
        {
            if (e.Key == "Enter")
            {
                SearchRestaurants();
            }
        }

    private void NavigateToCategory(CategoryItem category)
    {
        NavigationManager.NavigateTo($"/restaurants?category={Uri.EscapeDataString(category.Name)}");
    }

    private void ToggleCategories()
    {
        showAllCategories = !showAllCategories;
    }

    private class CategoryItem
    {
        public string Name { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
    }
}
