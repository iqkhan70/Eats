@page "/"
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject HttpClient Http

<PageTitle>Kram - Traditional Food Delivery</PageTitle>

<RadzenStack Gap="1.5rem" Style="padding: 1rem; width: 100%; max-width: 100vw; box-sizing: border-box;"
    Class="page-container">
    <RadzenText TextStyle="TextStyle.H1">Welcome to Kram</RadzenText>
    <RadzenText TextStyle="TextStyle.Body1">
        Discover authentic traditional food from local vendors, delivered to your door.
    </RadzenText>

    <RadzenCard Style="margin-top: 1rem;">
        <RadzenStack Gap="1rem">
            <RadzenText TextStyle="TextStyle.H3">Find Vendors Near You</RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.End"
                Class="search-container" Style="position: relative;">
                <RadzenFormField Text="Address or ZIP code" class="w-100" Style="flex: 1; position: relative;">
                    <RadzenTextBox @ref="searchTextBox" @bind-value="@searchLocation"
                        Placeholder="Enter address or ZIP code" @oninput="@HandleInput" @onkeypress="@HandleKeyPress"
                        Style="width: 100%;" />
                    @if (showSuggestions && suggestions.Any())
                    {
                        <div class="suggestions-dropdown"
                            style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            @foreach (var suggestion in suggestions)
                            {
                                <div class="suggestion-item"
                                    style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; @(hoveredSuggestion == suggestion ? "background-color: #f5f5f5;" : "")"
                                    @onclick="@(() => SelectSuggestion(suggestion))"
                                    @onmouseover="@(() => hoveredSuggestion = suggestion)"
                                    @onmouseout="@(() => hoveredSuggestion = null)">
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem"
                                        AlignItems="AlignItems.Center">
                                        <RadzenIcon Icon="location_on" Style="font-size: 16px; color: #666;" />
                                        <RadzenText TextStyle="TextStyle.Body2">@suggestion</RadzenText>
                                    </RadzenStack>
                                </div>
                            }
                        </div>
                    }
                </RadzenFormField>
                <RadzenButton Text="Search" Icon="search" Click="@SearchRestaurants" Variant="Variant.Flat" />
            </RadzenStack>
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.Body2">Within @((int)distanceMiles) miles</RadzenText>
                <RadzenSlider @bind-Value="@distanceMiles" Min="1" Max="100" Step="1"
                    Style="width: 100%; max-width: 320px;" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    <RadzenCard Style="margin-top: 1rem; width: 100%; max-width: 100%;" Class="categories-container">
        <RadzenStack Gap="1rem">
            <RadzenText TextStyle="TextStyle.H3">Popular Categories</RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" Style="flex-wrap: wrap; width: 100%;"
                Class="categories-stack">
                @foreach (var category in displayedCategories)
                {
                    <RadzenCard Style="cursor: pointer;" Class="category-card">
                        <div @onclick="@(() => NavigateToCategory(category))" style="width: 100%; height: 100%;">
                            <RadzenStack Gap="0.5rem" Style="align-items: center; text-align: center;">
                                <RadzenIcon Icon="@GetCategoryIcon(category.Name)" Style="font-size: 48px; color: var(--rz-primary);" />
                                <RadzenText TextStyle="TextStyle.Body1">@category.Name</RadzenText>
                            </RadzenStack>
                        </div>
                    </RadzenCard>
                }
            </RadzenStack>
            @if (categories.Count > initialCategoryCount)
            {
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center"
                    Style="margin-top: 0.5rem;">
                    <RadzenButton Text="@(showAllCategories ? "Show Less" : $"Show All ({categories.Count})")"
                        Icon="@(showAllCategories ? "expand_less" : "expand_more")" Click="@ToggleCategories"
                        Variant="Variant.Flat" Size="ButtonSize.Small" />
                </RadzenStack>
            }
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private RadzenTextBox? searchTextBox;
    private string searchLocation = string.Empty;
    private List<string> suggestions = new();
    private bool showSuggestions = false;
    private string? hoveredSuggestion = null;
    private bool showAllCategories = false;
    private const int initialCategoryCount = 6;
    private System.Threading.CancellationTokenSource? _debounceCts;
    private double distanceMiles = 25;

    protected override async Task OnInitializedAsync()
    {
        await LoadMenuCategoriesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && searchTextBox != null)
        {
            await searchTextBox.FocusAsync();
        }
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? string.Empty;
        searchLocation = value;
        await LoadSuggestions(value);
    }

    private async Task LoadSuggestions(string query)
    {
        if (string.IsNullOrWhiteSpace(query) || query.Length < 2)
        {
            suggestions = new List<string>();
            showSuggestions = false;
            StateHasChanged();
            return;
        }

        // Debounce the API call
        _debounceCts?.Cancel();
        _debounceCts = new System.Threading.CancellationTokenSource();

        try
        {
            await Task.Delay(300, _debounceCts.Token); // Wait 300ms after user stops typing

            var response = await Http.GetFromJsonAsync<List<string>>(
            $"WebBff/search-suggestions?query={Uri.EscapeDataString(query)}&maxResults=10",
            _debounceCts.Token);

            suggestions = response ?? new List<string>();
            showSuggestions = suggestions.Any();
            StateHasChanged();
        }
        catch (System.Threading.Tasks.TaskCanceledException)
        {
            // Debounce cancelled, ignore
        }
        catch (Exception)
        {
            suggestions = new List<string>();
            showSuggestions = false;
            StateHasChanged();
        }
    }

    private void SelectSuggestion(string suggestion)
    {
        searchLocation = suggestion;
        showSuggestions = false;
        suggestions = new List<string>();
        StateHasChanged();
    }

    private List<MenuCategoryDto> categories = new();

    private List<MenuCategoryDto> displayedCategories => showAllCategories
    ? categories
    : categories.Take(initialCategoryCount).ToList();

    private async Task LoadMenuCategoriesAsync()
    {
        try
        {
            var ts = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
            var result = await Http.GetFromJsonAsync<List<MenuCategoryDto>>($"WebBff/categories?__ts={ts}");
            categories = (result ?? new())
                .OrderBy(c => c.DisplayOrder)
                .ThenBy(c => c.Name)
                .ToList();
        }
        catch
        {
            categories = new();
        }
    }

    private async Task SearchRestaurants()
    {
        var location = (searchLocation ?? "").Trim();
        if (string.IsNullOrEmpty(location))
        {
            NavigationManager.NavigateTo("/restaurants");
            return;
        }
        var zipMatch = System.Text.RegularExpressions.Regex.Match(location, @"^\s*(\d{5})(?:-\d{4})?\s*$");
        if (zipMatch.Success)
        {
            var zip = zipMatch.Groups[1].Value;
            try
            {
                var geo = await Http.GetFromJsonAsync<GeocodeZipResponse>($"WebBff/geocode-zip?zip={Uri.EscapeDataString(zip)}");
                if (geo != null)
                {
                    var miles = (int)Math.Clamp(distanceMiles, 1, 100);
                    NavigationManager.NavigateTo($"/restaurants?latitude={geo.Latitude}&longitude={geo.Longitude}&distanceMiles={miles}&zip={Uri.EscapeDataString(zip)}");
                    return;
                }
            }
            catch { /* fallback to location text */ }
        }
        var milesParam = (int)Math.Clamp(distanceMiles, 1, 100);
        NavigationManager.NavigateTo($"/restaurants?location={Uri.EscapeDataString(location)}&distanceMiles={milesParam}");
    }

    private class GeocodeZipResponse { public double Latitude { get; set; } public double Longitude { get; set; } }

    private void HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            SearchRestaurants();
        }
    }

    private void NavigateToCategory(MenuCategoryDto category)
    {
        NavigationManager.NavigateTo($"/restaurants?menuCategoryId={Uri.EscapeDataString(category.CategoryId)}");
    }

    private static string GetCategoryIcon(string name)
    {
        var n = (name ?? "").Trim().ToLowerInvariant();
        if (n.Contains("drink") || n.Contains("beverage") || n.Contains("coffee") || n.Contains("tea")) return "local_drink";
        if (n.Contains("dessert") || n.Contains("sweet") || n.Contains("cake")) return "cake";
        if (n.Contains("grocery") || n.Contains("market")) return "shopping_bag";
        if (n.Contains("pharmacy") || n.Contains("medicine")) return "local_pharmacy";
        if (n.Contains("beauty") || n.Contains("salon")) return "spa";
        if (n.Contains("pet")) return "pets";
        if (n.Contains("pizza")) return "local_pizza";
        if (n.Contains("burger") || n.Contains("fast")) return "fastfood";
        return "category";
    }

    private void ToggleCategories()
    {
        showAllCategories = !showAllCategories;
    }

    private sealed class MenuCategoryDto
    {
        public string CategoryId { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public int DisplayOrder { get; set; }
    }
}
