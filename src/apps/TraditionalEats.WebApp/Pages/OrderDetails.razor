@page "/orders/{OrderId}"
@using TraditionalEats.WebApp.Models
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components
@using TraditionalEats.WebApp.Components
@using TraditionalEats.WebApp.Services
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject CartService CartService
@inject NotificationService NotificationService
@inject AuthService AuthService

<PageTitle>Order Details - Kram</PageTitle>

<RadzenStack Gap="1.5rem" Style="padding: 1rem; width: 100%; max-width: 100vw; box-sizing: border-box;" Class="page-container">
    @if (loading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else if (order == null)
    {
        <RadzenCard>
            <RadzenStack Gap="1rem" Style="align-items: center; padding: 2rem;">
                <RadzenIcon Icon="error" Style="font-size: 64px; color: var(--rz-text-secondary-color);" />
                <RadzenText TextStyle="TextStyle.H3">Order Not Found</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Style="color: var(--rz-text-secondary-color);">
                    The order you're looking for doesn't exist or you don't have permission to view it.
                </RadzenText>
                <RadzenButton Text="Back to Orders" Icon="arrow_back" Click="@(() => NavigationManager.NavigateTo("/orders"))" 
                             Variant="Variant.Flat" />
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenStack Gap="1.5rem">
            <!-- Header -->
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenButton Icon="arrow_back" Click="@(() => NavigationManager.NavigateTo("/orders"))" 
                             Variant="Variant.Flat" Size="ButtonSize.Small" />
                <RadzenText TextStyle="TextStyle.H1">Order Details</RadzenText>
                <div style="width: 40px;"></div> <!-- Spacer for centering -->
            </RadzenStack>

            <!-- Order Info Card -->
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.H4" Style="font-weight: bold;">
                                Order #@order.OrderId.ToString().Substring(0, 8)
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                                Placed on @order.CreatedAt.ToString("MMM dd, yyyy 'at' HH:mm")
                            </RadzenText>
                        </RadzenStack>
                        <RadzenStack Gap="0.5rem" AlignItems="AlignItems.End">
                            <RadzenBadge Text="@order.Status" Style="@GetStatusStyle(order.Status)" />
                            @if (CanCancelOrder)
                            {
                                <RadzenButton Text="Cancel Order"
                                              Icon="cancel"
                                              Variant="Variant.Outlined"
                                              Size="ButtonSize.Small"
                                              IsBusy="@cancelling"
                                              Disabled="@cancelling"
                                              Click="@CancelOrder"
                                              Style="border-color: #dc3545; color: #dc3545;" />
                            }
                        </RadzenStack>
                    </RadzenStack>

                    @if (order.EstimatedDeliveryAt.HasValue)
                    {
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="schedule" />
                            <RadzenText TextStyle="TextStyle.Body1">
                                Estimated delivery: @order.EstimatedDeliveryAt.Value.ToString("MMM dd, yyyy 'at' HH:mm")
                            </RadzenText>
                        </RadzenStack>
                    }

                    @if (!string.IsNullOrEmpty(order.DeliveryAddress))
                    {
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                            <RadzenIcon Icon="location_on" />
                            <RadzenText TextStyle="TextStyle.Body1">
                                @order.DeliveryAddress
                            </RadzenText>
                        </RadzenStack>
                    }
                </RadzenStack>
            </RadzenCard>

            <!-- Status History Timeline -->
            @if (order.StatusHistory != null && order.StatusHistory.Any())
            {
                <RadzenCard>
                    <RadzenStack Gap="1rem">
                        <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">Order Status</RadzenText>
                        <RadzenStack Gap="0.5rem">
                            @foreach (var statusEntry in order.StatusHistory.OrderBy(s => s.ChangedAt))
                            {
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Start">
                                    <div style="display: flex; flex-direction: column; align-items: center; min-width: 24px;">
                                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: var(--rz-primary); margin-top: 4px;"></div>
                                        @if (statusEntry != order.StatusHistory.OrderBy(s => s.ChangedAt).Last())
                                        {
                                            <div style="width: 2px; height: 40px; background-color: var(--rz-border-color); margin-top: 4px;"></div>
                                        }
                                    </div>
                                    <RadzenStack Gap="0.25rem" Style="flex: 1;">
                                        <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: 500;">
                                            @statusEntry.Status
                                        </RadzenText>
                                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                                            @statusEntry.ChangedAt.ToString("MMM dd, yyyy 'at' HH:mm")
                                        </RadzenText>
                                        @if (!string.IsNullOrEmpty(statusEntry.Notes))
                                        {
                                            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color); font-style: italic;">
                                                @statusEntry.Notes
                                            </RadzenText>
                                        }
                                    </RadzenStack>
                                </RadzenStack>
                            }
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            }

            <!-- Order Chat entry -->
            <RadzenCard Style="cursor: pointer;" @onclick="@(() => NavigationManager.NavigateTo($"/orders/{OrderId}/chat"))">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center"
                    JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Center">
                        <RadzenIcon Icon="chat" Style="font-size: 28px; color: var(--rz-primary);" />
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">Order Chat</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                                Message about this order
                            </RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                    <RadzenIcon Icon="chevron_right" Style="color: var(--rz-text-secondary-color);" />
                </RadzenStack>
            </RadzenCard>

            <!-- Order Items -->
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">Order Items</RadzenText>
                    <RadzenStack Gap="1rem">
                        @foreach (var item in order.Items)
                        {
                            <RadzenStack Gap="0.5rem">
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
                                    <RadzenStack Gap="0.25rem" Style="flex: 1;">
                                        <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: 500;">
                                            @item.Name
                                        </RadzenText>
                                        @if (!string.IsNullOrEmpty(item.Description))
                                        {
                                            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                                                @item.Description
                                            </RadzenText>
                                        }
                                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                                            Quantity: @item.Quantity Ã— $@item.UnitPrice.ToString("F2")
                                        </RadzenText>
                                    </RadzenStack>
                                    <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: bold;">
                                        $@item.TotalPrice.ToString("F2")
                                    </RadzenText>
                                </RadzenStack>
                                @if (!string.IsNullOrEmpty(item.ModifiersJson))
                                {
                                    try
                                    {
                                        var modifiers = System.Text.Json.JsonSerializer.Deserialize<List<string>>(item.ModifiersJson);
                                        @if (modifiers != null && modifiers.Any())
                                        {
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Style="flex-wrap: wrap;">
                                                @foreach (var modifier in modifiers)
                                                {
                                                    <RadzenBadge Text="@modifier" Variant="Variant.Flat" Size="BadgeSize.Small" />
                                                }
                                            </RadzenStack>
                                        }
                                    }
                                    catch { }
                                }
                            </RadzenStack>
                            @if (item != order.Items.Last())
                            {
                                <hr style="border: none; border-top: 1px solid var(--rz-border-color); margin: 0;" />
                            }
                        }
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>

            <!-- Review Section - Only show for completed/delivered orders -->
            @if ((order.Status == "Delivered" || order.Status == "Completed") && !hasReview)
            {
                <RadzenCard>
                    <RadzenStack Gap="1rem">
                        <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">Review Your Order</RadzenText>
                        <ReviewForm OrderId="@order.OrderId" RestaurantId="@order.RestaurantId" 
                                   OnReviewSubmitted="@HandleReviewSubmitted" />
                    </RadzenStack>
                </RadzenCard>
            }
            else if (hasReview && existingReview != null)
            {
                <RadzenCard>
                    <RadzenStack Gap="1rem">
                        <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">Your Review</RadzenText>
                        <ReviewDisplay Reviews="@(new List<ReviewDto> { existingReview })" />
                        <RadzenButton Text="Edit Review" Icon="edit" Variant="Variant.Flat" 
                                     Click="@(() => showEditForm = true)" />
                        @if (showEditForm)
                        {
                            <ReviewForm OrderId="@order.OrderId" RestaurantId="@order.RestaurantId" 
                                       ExistingReviewId="@existingReview.ReviewId"
                                       OnReviewSubmitted="@HandleReviewSubmitted"
                                       OnCancel="@(() => showEditForm = false)" />
                        }
                    </RadzenStack>
                </RadzenCard>
            }

            <!-- Reorder Button - Only show for past orders -->
            @if (IsPastOrder(order.Status))
            {
                <RadzenButton Text="Reorder" Icon="repeat" 
                    Click="@HandleReorder" 
                    Variant="Variant.Filled"
                    IsBusy="@reordering"
                    Style="width: 100%;" />
            }

            <!-- Order Summary -->
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">Order Summary</RadzenText>
                    <RadzenStack Gap="0.75rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText TextStyle="TextStyle.Body1">Subtotal</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1">$@order.Subtotal.ToString("F2")</RadzenText>
                        </RadzenStack>
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText TextStyle="TextStyle.Body1">Tax</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1">$@order.Tax.ToString("F2")</RadzenText>
                        </RadzenStack>
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText TextStyle="TextStyle.Body1">Delivery Fee</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1">$@order.DeliveryFee.ToString("F2")</RadzenText>
                        </RadzenStack>
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText TextStyle="TextStyle.Body1">Service fee</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1">$@order.ServiceFee.ToString("F2")</RadzenText>
                        </RadzenStack>
                        <hr style="border: none; border-top: 1px solid var(--rz-border-color); margin: 0.5rem 0;" />
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold;">Total</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="font-weight: bold; color: var(--rz-primary);">
                                $@order.Total.ToString("F2")
                            </RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenStack>
    }
</RadzenStack>

@code {
    [Parameter]
    public string OrderId { get; set; } = string.Empty;

    private bool loading = true;
    private OrderDetailsDto? order;
    private bool hasReview = false;
    private ReviewDto? existingReview;
    private bool showEditForm = false;
    private bool cancelling = false;

    private bool CanCancelOrder =>
        order != null &&
        (order.Status == "Pending" || order.Status == "Accepted");

    protected override async Task OnInitializedAsync()
    {
        await LoadOrder();
        if (order != null && (order.Status == "Delivered" || order.Status == "Completed"))
        {
            await CheckForExistingReview();
        }
    }

    private async Task LoadOrder()
    {
        try
        {
            loading = true;
            if (Guid.TryParse(OrderId, out var orderIdGuid))
            {
                var response = await Http.GetFromJsonAsync<OrderDetailsDto>($"WebBff/orders/{orderIdGuid}");
                order = response;
            }
            else
            {
                order = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading order: {ex.Message}");
            order = null;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task CancelOrder()
    {
        if (order == null) return;
        if (!Guid.TryParse(OrderId, out var orderIdGuid)) return;
        if (cancelling) return;

        try
        {
            cancelling = true;
            var response = await Http.PostAsync($"WebBff/orders/{orderIdGuid}/cancel", null);
            if (!response.IsSuccessStatusCode)
            {
                var body = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Cancel failed",
                    Detail = string.IsNullOrWhiteSpace(body) ? "Could not cancel this order." : body,
                    Duration = 5000
                });
                return;
            }

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Order cancelled",
                Detail = "Your order has been cancelled.",
                Duration = 4000
            });

            await LoadOrder();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Cancel failed",
                Detail = ex.Message,
                Duration = 5000
            });
        }
        finally
        {
            cancelling = false;
        }
    }

    private bool reordering = false;

    private bool IsPastOrder(string status)
    {
        return new[] { "Delivered", "Completed", "Cancelled", "Refunded" }.Contains(status);
    }

    private async Task HandleReorder()
    {
        if (order == null) return;

        try
        {
            reordering = true;

            // Get or create cart for this restaurant
            var cart = await CartService.GetCartAsync();
            Guid cartId;
            
            if (cart == null || cart.RestaurantId != order.RestaurantId)
            {
                // Create new cart for this restaurant
                cartId = await CartService.CreateCartAsync(order.RestaurantId);
            }
            else
            {
                cartId = cart.CartId;
            }

            // Add all items from the order to the cart
            foreach (var item in order.Items)
            {
                var response = await CartService.AddItemToCartAsync(
                    cartId,
                    item.MenuItemId,
                    item.Name,
                    item.UnitPrice,
                    item.Quantity
                );
                response.EnsureSuccessStatusCode();
            }

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Items Added to Cart",
                Detail = "All items from this order have been added to your cart.",
                Duration = 4000
            });

            // Navigate to cart after a short delay
            await Task.Delay(500);
            NavigationManager.NavigateTo("/cart");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reordering: {ex.Message}");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Failed to add items to cart. Please try again.",
                Duration = 4000
            });
        }
        finally
        {
            reordering = false;
        }
    }

    private string GetStatusStyle(string status)
    {
        return status switch
        {
            "Pending" => "background-color: #fff3cd; color: #856404;",
            "Confirmed" => "background-color: #d1ecf1; color: #0c5460;",
            "Preparing" => "background-color: #d4edda; color: #155724;",
            "Ready" => "background-color: #cce5ff; color: #004085;",
            "OutForDelivery" => "background-color: #e2e3e5; color: #383d41;",
            "Delivered" => "background-color: #d4edda; color: #155724;",
            "Cancelled" => "background-color: #f8d7da; color: #721c24;",
            _ => "background-color: #e9ecef; color: #495057;"
        };
    }

    public class OrderDetailsDto
    {
        public Guid OrderId { get; set; }
        public Guid CustomerId { get; set; }
        public Guid RestaurantId { get; set; }
        public decimal Subtotal { get; set; }
        public decimal Tax { get; set; }
        public decimal DeliveryFee { get; set; }
        public decimal ServiceFee { get; set; }
        public decimal Total { get; set; }
        public string Status { get; set; } = string.Empty;
        public string? DeliveryAddress { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime? EstimatedDeliveryAt { get; set; }
        public DateTime? DeliveredAt { get; set; }
        public List<OrderItemDetailsDto> Items { get; set; } = new();
        public List<OrderStatusHistoryDto> StatusHistory { get; set; } = new();
    }

    public class OrderItemDetailsDto
    {
        public Guid OrderItemId { get; set; }
        public Guid MenuItemId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
        public decimal TotalPrice { get; set; }
        public string? ModifiersJson { get; set; }
    }

    public class OrderStatusHistoryDto
    {
        public Guid Id { get; set; }
        public Guid OrderId { get; set; }
        public string Status { get; set; } = string.Empty;
        public string? Notes { get; set; }
        public DateTime ChangedAt { get; set; }
    }

    private async Task CheckForExistingReview()
    {
        try
        {
            var token = await AuthService.GetAccessTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                return;
            }

            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            var response = await Http.GetFromJsonAsync<List<ReviewDto>>("WebBff/reviews/me?skip=0&take=100");
            
            if (response != null && order != null)
            {
                existingReview = response.FirstOrDefault(r => r.OrderId == order.OrderId);
                hasReview = existingReview != null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking for existing review: {ex.Message}");
        }
    }

    private async Task HandleReviewSubmitted()
    {
        showEditForm = false;
        await CheckForExistingReview();
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Review Submitted",
            Detail = "Thank you for your review!",
            Duration = 3000
        });
    }
}
