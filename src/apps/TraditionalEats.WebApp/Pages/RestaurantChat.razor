@page "/restaurants/{restaurantId:guid}/chat"
@using System.Net.Http.Json
@using Radzen
@using TraditionalEats.WebApp.Components
@using TraditionalEats.WebApp.Services
@inject HttpClient Http
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<PageTitle>Vendor Chat - Kram</PageTitle>

@if (!isAuthChecked)
{
    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else if (!isAuthenticated)
{
    <RadzenAlert AlertStyle="AlertStyle.Warning" Title="Authentication Required" Text="Please log in to chat with the vendor." />
}
else if (loading)
{
    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else if (conversationId == Guid.Empty)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Title="Error" Text="Could not start a chat with this vendor." />
}
else
{
    <VendorChat ConversationId="@conversationId" FullScreen="true" />
}

@code {
    [Parameter] public Guid RestaurantId { get; set; }

    private bool isAuthChecked;
    private bool isAuthenticated;
    private bool loading = true;
    private Guid conversationId;

    protected override async Task OnInitializedAsync()
    {
        isAuthChecked = false;
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        isAuthChecked = true;

        if (!isAuthenticated)
        {
            loading = false;
            return;
        }

        try
        {
            loading = true;
            var resp = await Http.PostAsJsonAsync("WebBff/vendor-chat/conversations", new { restaurantId = RestaurantId });
            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Chat error",
                    Detail = body
                });
                conversationId = Guid.Empty;
                return;
            }

            var json = await resp.Content.ReadFromJsonAsync<System.Text.Json.JsonElement>();
            if (json.TryGetProperty("conversationId", out var idEl))
            {
                conversationId = Guid.Parse(idEl.GetString()!);
            }
        }
        catch
        {
            conversationId = Guid.Empty;
        }
        finally
        {
            loading = false;
        }
    }
}

