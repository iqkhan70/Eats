@page "/restaurants"
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components
@implements IDisposable
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Restaurants - TraditionalEats</PageTitle>

<RadzenStack Gap="1.5rem" Style="padding: 1rem; width: 100%; max-width: 100vw; box-sizing: border-box;" Class="page-container">
    <RadzenText TextStyle="TextStyle.H1">Restaurants</RadzenText>
    
    @if (loading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else if (restaurants.Any())
    {
        <RadzenDataGrid Data="@restaurants" TItem="RestaurantDto" AllowPaging="true" PageSize="12" AllowSorting="true" AllowFiltering="true" FilterMode="FilterMode.Advanced" Class="restaurants-grid">
            <Columns>
                <RadzenDataGridColumn TItem="RestaurantDto" Property="Name" Title="Restaurant" Width="200px">
                    <Template Context="restaurant">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="restaurant" Style="font-size: 40px; color: var(--rz-primary);" />
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: bold;">@restaurant.Name</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">@restaurant.CuisineType</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="RestaurantDto" Property="Address" Title="Address" />
                <RadzenDataGridColumn TItem="RestaurantDto" Property="Rating" Title="Rating" Width="100px">
                    <Template Context="restaurant">
                        @if (restaurant.Rating.HasValue)
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <RadzenIcon Icon="star" Style="color: gold;" />
                                <RadzenText>@restaurant.Rating.Value.ToString("F1")</RadzenText>
                            </RadzenStack>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="RestaurantDto" Title="Actions" Sortable="false" Filterable="false" Width="150px">
                    <Template Context="restaurant">
                        <RadzenButton Text="View Menu" Icon="menu" Click="@(() => ViewMenu(restaurant.RestaurantId))" Variant="Variant.Flat" Size="ButtonSize.Small" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
    else
    {
        <RadzenCard>
            <RadzenText>No restaurants found.</RadzenText>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private bool loading = true;
    private List<RestaurantDto> restaurants = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRestaurants();
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload when query parameters change
        await LoadRestaurants();
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Reload when navigation occurs (e.g., category click)
        await LoadRestaurants();
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadRestaurants()
    {
        try
        {
            loading = true;
            
            // Get query parameters from URL
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            string? location = null;
            string? category = null;
            
            // Parse query string manually (Blazor WebAssembly doesn't have WebUtilities)
            if (!string.IsNullOrEmpty(uri.Query))
            {
                var query = uri.Query.TrimStart('?');
                var pairs = query.Split('&');
                foreach (var pair in pairs)
                {
                    var parts = pair.Split('=', 2);
                    if (parts.Length == 2)
                    {
                        var key = Uri.UnescapeDataString(parts[0]);
                        var value = Uri.UnescapeDataString(parts[1]);
                        if (key == "location") location = value;
                        if (key == "category") category = value;
                    }
                }
            }
            
            // Build query string
            var queryParams = new List<string>();
            if (!string.IsNullOrEmpty(location)) queryParams.Add($"location={Uri.EscapeDataString(location)}");
            if (!string.IsNullOrEmpty(category)) queryParams.Add($"cuisineType={Uri.EscapeDataString(category)}");
            var queryString = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
            
            var response = await Http.GetFromJsonAsync<List<RestaurantDto>>(
                $"WebBff/restaurants{queryString}",
                new System.Text.Json.JsonSerializerOptions 
                { 
                    PropertyNameCaseInsensitive = true 
                });
            restaurants = response ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading restaurants: {ex.Message}");
            restaurants = new();
        }
        finally
        {
            loading = false;
        }
    }

    private void ViewMenu(Guid restaurantId)
    {
        NavigationManager.NavigateTo($"/restaurants/{restaurantId}/menu");
    }

    public class RestaurantDto
    {
        public Guid RestaurantId { get; set; }
        public Guid OwnerId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string? CuisineType { get; set; }
        public string? ImageUrl { get; set; }
        public string? PhoneNumber { get; set; }
        public string? Email { get; set; }
        public string Address { get; set; } = string.Empty;
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public bool IsActive { get; set; }
        public decimal? Rating { get; set; }
        public int? ReviewCount { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime UpdatedAt { get; set; }
    }
}
