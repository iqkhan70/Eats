@page "/restaurants"
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components
@using TraditionalEats.WebApp.Components
@implements IDisposable
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject DialogService DialogService

<PageTitle>Vendors - Kram</PageTitle>

<RadzenStack Gap="1.5rem" Style="padding: 1rem; width: 100%; max-width: 100vw; box-sizing: border-box;"
    Class="page-container">
    <RadzenText TextStyle="TextStyle.H1">Vendors</RadzenText>

    <RadzenCard>
        <RadzenStack Gap="0.75rem">
            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                Filter vendors by menu category
            </RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Center" Style="flex-wrap: wrap;">
                <RadzenDropDown Data="@menuCategories"
                                @bind-Value="@selectedMenuCategoryId"
                                TextProperty="Name"
                                ValueProperty="CategoryId"
                                Placeholder="All categories"
                                Style="min-width: 320px;"
                                Change="@OnMenuCategoryChanged" />
                <RadzenButton Text="Clear" Icon="close" Variant="Variant.Outlined" Size="ButtonSize.Small"
                              Click="@ClearMenuCategory" Disabled="@string.IsNullOrEmpty(selectedMenuCategoryId)" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    @if (loading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else if (restaurants.Any())
    {
        <RadzenDataGrid Data="@restaurants" TItem="RestaurantDto" AllowPaging="true" PageSize="12" AllowSorting="true"
            AllowFiltering="true" FilterMode="FilterMode.Advanced" Class="restaurants-grid">
            <Columns>
                <RadzenDataGridColumn TItem="RestaurantDto" Property="Name" Title="Vendor" Width="200px">
                    <Template Context="restaurant">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                            <span @onclick="@(() => ShowVendorImageFullSize(restaurant))" style="@(string.IsNullOrEmpty(restaurant.ImageUrl) ? "cursor: default; " : "cursor: pointer; ")position: relative; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                                <RadzenIcon Icon="restaurant" Style="font-size: 40px; color: var(--rz-primary);" />
                                @if (!string.IsNullOrEmpty(restaurant.ImageUrl))
                                {
                                    <img src="@GetMenuImageDisplayUrl(restaurant.ImageUrl)" alt="@restaurant.Name" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" onerror="this.style.display='none'" />
                                }
                            </span>
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: bold;">@restaurant.Name
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                                    @restaurant.CuisineType</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="RestaurantDto" Property="Address" Title="Address" />
                @if (searchCenterLat.HasValue && searchCenterLon.HasValue)
                {
                    <RadzenDataGridColumn TItem="RestaurantDto" Title="Distance" Width="100px" Sortable="false">
                        <Template Context="r">
                            @{
                                var dist = GetDisplayDistance(r.Latitude, r.Longitude);
                            }
                            <RadzenText>@dist</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>
                }
                <RadzenDataGridColumn TItem="RestaurantDto" Property="Rating" Title="Rating" Width="100px">
                    <Template Context="restaurant">
                        @if (restaurant.Rating.HasValue)
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <RadzenIcon Icon="star" Style="color: gold;" />
                                <RadzenText>@restaurant.Rating.Value.ToString("F1")</RadzenText>
                            </RadzenStack>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="RestaurantDto" Title="Actions" Sortable="false" Filterable="false"
                    Width="150px">
                    <Template Context="restaurant">
                        <RadzenButton Text="View Menu" Icon="menu" Click="@(() => ViewMenu(restaurant.RestaurantId))"
                            Variant="Variant.Flat" Size="ButtonSize.Small" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
    else if (!string.IsNullOrEmpty(loadError))
    {
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.Body1" Style="color: var(--rz-danger);">@loadError</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin-top: 0.5rem;">Make sure the Web BFF and Vendor (Restaurant) Service
                are running (see README / launch settings).</RadzenText>
        </RadzenCard>
    }
    else
    {
        <RadzenCard>
            <RadzenText>No vendors found.</RadzenText>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private bool loading = true;
    private List<RestaurantDto> restaurants = new();
    private List<MenuCategoryDto> menuCategories = new();
    private string? selectedMenuCategoryId;
    private string? loadError;
    private double? searchCenterLat;
    private double? searchCenterLon;

    protected override async Task OnInitializedAsync()
    {
        await LoadMenuCategories();
        await LoadRestaurants();
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload when query parameters change
        await LoadRestaurants();
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Reload when navigation occurs (e.g., category click)
        await LoadRestaurants();
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadRestaurants()
    {
        loadError = null;
        try
        {
            loading = true;

            // Get query parameters from URL
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            string? location = null;
            string? category = null;
            string? menuCategoryId = null;
            string? zip = null;
            double? latitude = null;
            double? longitude = null;
            double? distanceMiles = null;

            if (!string.IsNullOrEmpty(uri.Query))
            {
                var query = uri.Query.TrimStart('?');
                var pairs = query.Split('&');
                foreach (var pair in pairs)
                {
                    var parts = pair.Split('=', 2);
                    if (parts.Length == 2)
                    {
                        var key = Uri.UnescapeDataString(parts[0]);
                        var value = Uri.UnescapeDataString(parts[1]);
                        if (key == "location") location = value;
                        if (key == "category") category = value;
                        if (key == "menuCategoryId") menuCategoryId = value;
                        if (key == "zip") zip = value;
                        if (key == "latitude" && double.TryParse(value, System.Globalization.NumberStyles.Any,
                        System.Globalization.CultureInfo.InvariantCulture, out var lat)) latitude = lat;
                        if (key == "longitude" && double.TryParse(value, System.Globalization.NumberStyles.Any,
                        System.Globalization.CultureInfo.InvariantCulture, out var lon)) longitude = lon;
                        if (key == "distanceMiles" && double.TryParse(value, System.Globalization.NumberStyles.Any,
                        System.Globalization.CultureInfo.InvariantCulture, out var mi)) distanceMiles = mi;
                    }
                }
            }

            searchCenterLat = latitude;
            searchCenterLon = longitude;

            var queryParams = new List<string>();
            if (!string.IsNullOrEmpty(location)) queryParams.Add($"location={Uri.EscapeDataString(location)}");
            if (!string.IsNullOrEmpty(category)) queryParams.Add($"cuisineType={Uri.EscapeDataString(category)}");
            if (!string.IsNullOrEmpty(menuCategoryId)) queryParams.Add($"menuCategoryId={Uri.EscapeDataString(menuCategoryId)}");
            if (!string.IsNullOrEmpty(zip)) queryParams.Add($"zip={Uri.EscapeDataString(zip)}");
            if (latitude.HasValue) queryParams.Add($"latitude={latitude.Value}");
            if (longitude.HasValue) queryParams.Add($"longitude={longitude.Value}");
            if (distanceMiles.HasValue) queryParams.Add($"radiusMiles={distanceMiles.Value}");
            queryParams.Add("take=100");
            queryParams.Add("__ts=" + DateTimeOffset.UtcNow.ToUnixTimeMilliseconds());
            var queryString = "?" + string.Join("&", queryParams);

            var response = await Http.GetAsync($"WebBff/restaurants{queryString}");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var options = new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                var list = System.Text.Json.JsonSerializer.Deserialize<List<RestaurantDto>>(json, options);
                restaurants = list ?? new();
            }
            else
            {
                var body = await response.Content.ReadAsStringAsync();
                loadError = $"Could not load vendors (HTTP {(int)response.StatusCode}). {body}";
                restaurants = new();
            }
        }
        catch (Exception ex)
        {
            loadError = $"Could not load vendors: {ex.Message}";
            restaurants = new();
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadMenuCategories()
    {
        try
        {
            var response = await Http.GetAsync("WebBff/categories?__ts=" + DateTimeOffset.UtcNow.ToUnixTimeMilliseconds());
            if (!response.IsSuccessStatusCode)
            {
                menuCategories = new();
                return;
            }

            var json = await response.Content.ReadAsStringAsync();
            var options = new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            var list = System.Text.Json.JsonSerializer.Deserialize<List<MenuCategoryDto>>(json, options) ?? new();
            menuCategories = list.OrderBy(c => c.DisplayOrder).ThenBy(c => c.Name).ToList();
        }
        catch
        {
            menuCategories = new();
        }
    }

    private void OnMenuCategoryChanged(object? value)
    {
        selectedMenuCategoryId = value?.ToString();
        NavigateWithMenuCategory(selectedMenuCategoryId);
    }

    private void ClearMenuCategory()
    {
        selectedMenuCategoryId = null;
        NavigateWithMenuCategory(null);
    }

    private void NavigateWithMenuCategory(string? menuCategoryId)
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        if (!string.IsNullOrEmpty(uri.Query))
        {
            var query = uri.Query.TrimStart('?');
            foreach (var pair in query.Split('&', StringSplitOptions.RemoveEmptyEntries))
            {
                var parts = pair.Split('=', 2);
                var key = Uri.UnescapeDataString(parts[0]);
                var value = parts.Length == 2 ? Uri.UnescapeDataString(parts[1]) : "";
                if (!string.IsNullOrWhiteSpace(key))
                    dict[key] = value;
            }
        }
        dict.Remove("menuCategoryId");
        if (!string.IsNullOrWhiteSpace(menuCategoryId))
            dict["menuCategoryId"] = menuCategoryId;

        var qs = string.Join("&", dict.Select(kvp => $"{Uri.EscapeDataString(kvp.Key)}={Uri.EscapeDataString(kvp.Value)}"));
        NavigationManager.NavigateTo("/restaurants" + (string.IsNullOrEmpty(qs) ? "" : "?" + qs));
    }

    private void ViewMenu(Guid restaurantId)
    {
        NavigationManager.NavigateTo($"/restaurants/{restaurantId}/menu");
    }

    private string GetMenuImageDisplayUrl(string? imageUrl)
    {
        if (string.IsNullOrWhiteSpace(imageUrl)) return "";
        if (imageUrl.StartsWith("http://", StringComparison.OrdinalIgnoreCase) || imageUrl.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
            return imageUrl;
        var baseUri = Http.BaseAddress?.ToString().TrimEnd('/') ?? (NavigationManager.BaseUri.TrimEnd('/') + "/api");
        return $"{baseUri}/WebBff/menu-image?path={Uri.EscapeDataString(imageUrl)}";
    }

    private void ShowVendorImageFullSize(RestaurantDto restaurant)
    {
        if (string.IsNullOrWhiteSpace(restaurant.ImageUrl)) return;
        DialogService.OpenAsync<MenuImageDialog>("", new Dictionary<string, object>
        {
            ["ImageUrl"] = GetMenuImageDisplayUrl(restaurant.ImageUrl),
            ["ItemName"] = restaurant.Name
        }, new DialogOptions { Width = "90vw", Height = "90vh", CloseDialogOnOverlayClick = true });
    }

    private static double DistanceMiles(double lat1, double lon1, double lat2, double lon2)
    {
        const double R = 3959;
        var dLat = (lat2 - lat1) * Math.PI / 180;
        var dLon = (lon2 - lon1) * Math.PI / 180;
        var a = Math.Sin(dLat / 2) * Math.Sin(dLat / 2) +
        Math.Cos(lat1 * Math.PI / 180) * Math.Cos(lat2 * Math.PI / 180) *
        Math.Sin(dLon / 2) * Math.Sin(dLon / 2);
        var c = 2 * Math.Atan2(Math.Sqrt(a), Math.Sqrt(1 - a));
        return R * c;
    }

    // Returns display text for distance; shows "Same ZIP" when coords are invalid (0,0) or distance > 200 mi.
    private string GetDisplayDistance(double? restaurantLat, double? restaurantLon)
    {
        if (!searchCenterLat.HasValue || !searchCenterLon.HasValue) return "â€”";
        if (!restaurantLat.HasValue || !restaurantLon.HasValue) return "Same ZIP";
        // Treat (0,0) or near it as invalid placeholder coordinates
        if (Math.Abs(restaurantLat.Value) < 0.01 && Math.Abs(restaurantLon.Value) < 0.01) return "Same ZIP";
        var mi = DistanceMiles(searchCenterLat.Value, searchCenterLon.Value, restaurantLat.Value, restaurantLon.Value);
        if (mi > 200) return "Same ZIP"; // Unreasonably large = bad coords, same-ZIP fallback
        return $"{mi:F1} mi";
    }

    public class RestaurantDto
    {
        public Guid RestaurantId { get; set; }
        public Guid OwnerId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string? CuisineType { get; set; }
        public string? ImageUrl { get; set; }
        public string? PhoneNumber { get; set; }
        public string? Email { get; set; }
        public string Address { get; set; } = string.Empty;
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public bool IsActive { get; set; }
        public decimal? Rating { get; set; }
        public int? ReviewCount { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime UpdatedAt { get; set; }
    }

    public class MenuCategoryDto
    {
        public string CategoryId { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public int DisplayOrder { get; set; }
    }
}
