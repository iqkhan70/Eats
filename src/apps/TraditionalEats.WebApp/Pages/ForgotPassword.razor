@page "/forgot-password"
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Forgot Password - TraditionalEats</PageTitle>

<RadzenStack Gap="1.5rem"
    Style="padding: 1rem; max-width: 400px; margin: 2rem auto; width: 100%; box-sizing: border-box;">
    <RadzenText TextStyle="TextStyle.H1">Forgot Password</RadzenText>
    <RadzenText TextStyle="TextStyle.Body1">Enter your email and we'll send you a link to reset your password.
    </RadzenText>

    <RadzenCard>
        <RadzenStack Gap="1rem">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <RadzenAlert AlertStyle="AlertStyle.Danger" Title="Error" Text="@errorMessage" />
            }
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <RadzenAlert AlertStyle="AlertStyle.Success" Title="Done" Text="@successMessage" />
            }

            <RadzenFormField Text="Email" class="w-100">
                <RadzenTextBox @bind-Value="@email" Placeholder="Enter your email" Style="width: 100%;"
                    Disabled="@loading" />
            </RadzenFormField>

            <RadzenButton Text="Send Reset Link" Icon="email" Click="@HandleForgotPassword" Variant="Variant.Filled"
                Style="width: 100%;" IsBusy="@loading" Disabled="@loading" />

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="0.5rem">
                <RadzenLink Path="/login" Text="Back to Login" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private string email = string.Empty;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool loading = false;

    private async Task HandleForgotPassword()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(email))
        {
            errorMessage = "Please enter your email address.";
            return;
        }

        try
        {
            loading = true;
            var request = new { Email = email.Trim() };
            var response = await Http.PostAsJsonAsync("WebBff/auth/forgot-password", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ForgotPasswordResponse>();
                if (result != null && result.Success)
                {
                    successMessage = result.Message ?? "If an account with that email exists, a password reset link has been sent.";
                    email = string.Empty;
                }
                else
                    errorMessage = result?.Message ?? "An error occurred. Please try again.";
            }
            else
            {
                var body = await response.Content.ReadAsStringAsync();
                try
                {
                    var err = System.Text.Json.JsonSerializer.Deserialize<ForgotPasswordResponse>(body);
                    errorMessage = err?.Message ?? "Request failed. Please try again.";
                }
                catch
                {
                    errorMessage = "Request failed. Please try again.";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private class ForgotPasswordResponse
    {
        public bool Success { get; set; }
        public string? Message { get; set; }
    }
}
