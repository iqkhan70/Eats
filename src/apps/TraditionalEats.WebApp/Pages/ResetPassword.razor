@page "/reset-password"
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Reset Password - TraditionalEats</PageTitle>

<RadzenStack Gap="1.5rem" Style="padding: 1rem; max-width: 400px; margin: 2rem auto; width: 100%; box-sizing: border-box;">
    <RadzenText TextStyle="TextStyle.H1">Reset Password</RadzenText>
    <RadzenText TextStyle="TextStyle.Body1">Enter your new password below.</RadzenText>

    <RadzenCard>
        <RadzenStack Gap="1rem">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <RadzenAlert AlertStyle="AlertStyle.Danger" Title="Error" Text="@errorMessage" />
            }
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <RadzenAlert AlertStyle="AlertStyle.Success" Title="Success" Text="@successMessage" />
            }

            <RadzenFormField Text="Email" class="w-100">
                <RadzenTextBox @bind-Value="@email" Placeholder="Your email" Style="width: 100%;" Disabled="@(isSuccess || loading)" />
            </RadzenFormField>

            <RadzenFormField Text="Reset token" class="w-100">
                <RadzenTextBox @bind-Value="@token" Placeholder="Token from email (or paste from link)" Style="width: 100%;" Disabled="@(isSuccess || loading)" />
            </RadzenFormField>

            <RadzenFormField Text="New Password" class="w-100">
                <RadzenPassword @bind-Value="@newPassword" Placeholder="New password (min 6 characters)" Style="width: 100%;" Disabled="@(isSuccess || loading)" />
            </RadzenFormField>

            <RadzenFormField Text="Confirm Password" class="w-100">
                <RadzenPassword @bind-Value="@confirmPassword" Placeholder="Confirm new password" Style="width: 100%;" Disabled="@(isSuccess || loading)" />
            </RadzenFormField>

            <RadzenButton Text="Reset Password" Icon="lock_reset" Click="@HandleResetPassword" Variant="Variant.Filled" Style="width: 100%;" IsBusy="@loading" Disabled="@(isSuccess || loading)" />

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="0.5rem">
                <RadzenLink Path="/login" Text="Back to Login" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "token")]
    public string? TokenFromQuery { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "email")]
    public string? EmailFromQuery { get; set; }

    private string email = string.Empty;
    private string token = string.Empty;
    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool loading = false;
    private bool isSuccess = false;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrWhiteSpace(EmailFromQuery))
            email = EmailFromQuery;
        if (!string.IsNullOrWhiteSpace(TokenFromQuery))
            token = TokenFromQuery;
        if (string.IsNullOrEmpty(token) && string.IsNullOrEmpty(email))
            errorMessage = "Invalid reset link. Use the link from your email or request a new one.";
    }

    private async Task HandleResetPassword()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(email))
        {
            errorMessage = "Email is required.";
            return;
        }
        if (string.IsNullOrWhiteSpace(token))
        {
            errorMessage = "Token is required. Use the link from your email or request a new password reset.";
            return;
        }
        if (string.IsNullOrWhiteSpace(newPassword) || newPassword.Length < 6)
        {
            errorMessage = "Password must be at least 6 characters.";
            return;
        }
        if (newPassword != confirmPassword)
        {
            errorMessage = "Passwords do not match.";
            return;
        }

        try
        {
            loading = true;
            var request = new
            {
                Token = token,
                Email = email.Trim(),
                NewPassword = newPassword,
                ConfirmPassword = confirmPassword
            };
            var response = await Http.PostAsJsonAsync("WebBff/auth/reset-password", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ResetPasswordResponse>();
                if (result != null && result.Success)
                {
                    successMessage = result.Message ?? "Password has been reset. You can now login.";
                    isSuccess = true;
                    newPassword = string.Empty;
                    confirmPassword = string.Empty;
                }
                else
                    errorMessage = result?.Message ?? "Reset failed. Please try again or request a new link.";
            }
            else
            {
                var result = await response.Content.ReadFromJsonAsync<ResetPasswordResponse>();
                errorMessage = result?.Message ?? "Reset failed. The link may have expired. Please request a new one.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private class ResetPasswordResponse
    {
        public bool Success { get; set; }
        public string? Message { get; set; }
    }
}
