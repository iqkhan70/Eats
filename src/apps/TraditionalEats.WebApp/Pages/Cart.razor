@page "/cart"
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components
@using TraditionalEats.WebApp.Services
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject CartService CartService
@inject NotificationService NotificationService

<PageTitle>Cart - Kram</PageTitle>

<RadzenStack Gap="1.5rem" Style="padding: 1rem; width: 100%; max-width: 100vw; box-sizing: border-box;"
    Class="page-container">
    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
        <RadzenButton Icon="arrow_back" Click="@GoBack" Variant="Variant.Flat" Size="ButtonSize.Small" />
        <RadzenText TextStyle="TextStyle.H1">Shopping Cart</RadzenText>
    </RadzenStack>

    @* Payment readiness banner - show if vendor cannot accept payments AND cart has items *@
    @if (!loading && cart != null && cart.Items != null && cart.Items.Any() && cart.RestaurantId.HasValue && !paymentReady)
    {
        <RadzenCard Style="background: var(--rz-warning); color: #000; border: none;">
            <RadzenStack Gap="1rem">
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: bold;">⚠️ Cannot Place Order</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">@paymentBlockedMessage</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>
    }

    @if (loading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else if (cart != null && cart.Items != null && cart.Items.Any())
    {
        <RadzenCard>
            <RadzenStack Gap="1rem">
                @foreach (var item in cart.Items)
                {
                    <RadzenCard>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center"
                            Style="flex-wrap: wrap;">
                            <RadzenStack Gap="0.5rem" Style="flex: 1; min-width: 200px;">
                                <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: bold;">@item.Name</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                                    $@item.UnitPrice.ToString("F2") each
                                </RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <RadzenButton Icon="remove" Click="@(() => DecreaseQuantity(item))" Variant="Variant.Flat"
                                    Size="ButtonSize.Small" />
                                <RadzenText TextStyle="TextStyle.Body1" Style="min-width: 30px; text-align: center;">
                                    @item.Quantity</RadzenText>
                                <RadzenButton Icon="add" Click="@(() => IncreaseQuantity(item))" Variant="Variant.Flat"
                                    Size="ButtonSize.Small" />
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.H4" Style="min-width: 80px; text-align: right;">
                                $@item.TotalPrice.ToString("F2")
                            </RadzenText>
                            <RadzenButton Icon="delete" Click="@(() => RemoveItem(item))" Variant="Variant.Flat"
                                Size="ButtonSize.Small" />
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>
        </RadzenCard>

        <RadzenCard>
            <RadzenStack Gap="0.75rem">
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText TextStyle="TextStyle.Body1">Subtotal</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1">$@cart.Subtotal.ToString("F2")</RadzenText>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText TextStyle="TextStyle.Body1">Tax</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1">$@cart.Tax.ToString("F2")</RadzenText>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText TextStyle="TextStyle.Body1">Delivery Fee</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1">$@cart.DeliveryFee.ToString("F2")</RadzenText>
                </RadzenStack>
                @{
                    var amountBeforeServiceFee = cart.Subtotal + cart.Tax + cart.DeliveryFee;
                    var serviceFee = Math.Min(amountBeforeServiceFee * 0.02m, 5.00m);
                    var totalWithServiceFee = amountBeforeServiceFee + serviceFee;
                }
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText TextStyle="TextStyle.Body1">Service Fee</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1">$@serviceFee.ToString("F2")</RadzenText>
                </RadzenStack>
                <hr style="border: none; border-top: 1px solid var(--rz-border-color); margin: 0.5rem 0;" />
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText TextStyle="TextStyle.H4" Style="font-weight: bold;">Total</RadzenText>
                    <RadzenText TextStyle="TextStyle.H4" Style="font-weight: bold; color: var(--rz-primary);">
                        $@totalWithServiceFee.ToString("F2")
                    </RadzenText>
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>

        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Delivery Address" class="w-100">
                    <RadzenTextBox @bind-Value="@deliveryAddress" Placeholder="Enter your delivery address"
                        Disabled="true" />
                </RadzenFormField>
                <RadzenFormField Text="Special Instructions (Optional)" class="w-100">
                    <RadzenTextArea @bind-Value="@specialInstructions" 
                        Placeholder="e.g., 'Cut with clean knife', 'I will pick it up around 3 PM CST', etc."
                        Rows="3" Style="width: 100%;" />
                </RadzenFormField>
                <RadzenButton Text="Place Order" Icon="shopping_cart" Click="@PlaceOrder" Variant="Variant.Filled"
                    IsLoading="@placingOrder" Disabled="@(isPlaceOrderDisabled || !paymentReady)" Class="w-100" />
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenCard>
            <RadzenStack Gap="1rem" Style="align-items: center; padding: 2rem;">
                <RadzenIcon Icon="shopping_cart" Style="font-size: 64px; color: var(--rz-text-secondary-color);" />
                <RadzenText TextStyle="TextStyle.H3">Your cart is empty</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Style="color: var(--rz-text-secondary-color);">
                    Add items from the menu to get started
                </RadzenText>
                <RadzenButton Text="Browse Vendors" Icon="restaurant"
                    Click="@(() => NavigationManager.NavigateTo("/restaurants"))" Variant="Variant.Flat" />
            </RadzenStack>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private bool loading = true;
    private bool placingOrder = false;
    private CartDto? cart;
    private string deliveryAddress = "Delivery is not available yet, might be available later based on customer needs. Pickup only!";
    private string specialInstructions = string.Empty;
    private bool paymentReady = true; // Default to true, check when cart loads
    private string paymentBlockedMessage = "This vendor is not set up to accept payments yet. Please contact the vendor directly or try again later.";

    private bool isPlaceOrderDisabled => placingOrder || string.IsNullOrWhiteSpace(deliveryAddress) || !paymentReady;

    protected override async Task OnInitializedAsync()
    {
        await LoadCart();
    }

    private async Task LoadCart()
    {
        try
        {
            loading = true;
            cart = await CartService.GetCartAsync();
            
            // Check payment readiness if cart has a vendor
            if (cart != null && cart.RestaurantId.HasValue)
            {
                await CheckPaymentReadiness(cart.RestaurantId.Value);
            }
            else
            {
                paymentReady = true; // Reset if no vendor
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading cart: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            cart = null;
            paymentReady = true; // Default to allowing orders if check fails
        }
        finally
        {
            loading = false;
        }
    }

    private async Task CheckPaymentReadiness(Guid restaurantId)
    {
        try
        {
            var response = await Http.GetAsync($"WebBff/payments/restaurant/{restaurantId}/payment-ready");
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<PaymentReadyResponse>();
                paymentReady = result?.PaymentReady ?? true;
                if (!paymentReady)
                {
                    paymentBlockedMessage = "This vendor is not set up to accept payments yet. Please contact the vendor directly or try again later.";
                }
            }
            else
            {
                // If check fails, allow orders (fail open)
                paymentReady = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking payment readiness: {ex.Message}");
            // Fail open - allow orders if check fails
            paymentReady = true;
        }
    }

    private async Task IncreaseQuantity(CartItemDto item)
    {
        if (cart == null) return;
        try
        {
            await CartService.UpdateCartItemQuantityAsync(cart.CartId, item.CartItemId, item.Quantity + 1);
            await LoadCart();
            // Trigger navigation to refresh cart count in MainLayout
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: false);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error increasing quantity: {ex.Message}");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to update quantity: {ex.Message}"
            });
        }
    }

    private async Task DecreaseQuantity(CartItemDto item)
    {
        if (cart == null) return;
        try
        {
            if (item.Quantity > 1)
            {
                await CartService.UpdateCartItemQuantityAsync(cart.CartId, item.CartItemId, item.Quantity - 1);
                await LoadCart();
                // Trigger navigation to refresh cart count in MainLayout
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: false);
            }
            else
            {
                await RemoveItem(item);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error decreasing quantity: {ex.Message}");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to update quantity: {ex.Message}"
            });
        }
    }

    private async Task RemoveItem(CartItemDto item)
    {
        if (cart == null) return;
        await CartService.RemoveCartItemAsync(cart.CartId, item.CartItemId);
        await LoadCart();
        // Reset payment readiness when cart becomes empty (user might switch vendors)
        if (cart == null || cart.Items == null || !cart.Items.Any())
        {
            paymentReady = true;
            paymentBlockedMessage = "This vendor is not set up to accept payments yet. Please contact the vendor directly or try again later.";
        }
        // Trigger navigation to refresh cart count in MainLayout
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: false);
    }

    private async Task PlaceOrder()
    {
        if (cart == null || string.IsNullOrWhiteSpace(deliveryAddress)) return;

        try
        {
            placingOrder = true;
            var result = await CartService.PlaceOrderAsync(cart.CartId, deliveryAddress,
                string.IsNullOrWhiteSpace(specialInstructions) ? null : specialInstructions);

            // Clear cart state immediately after successful order placement
            cart = null;
            deliveryAddress = string.Empty;
            specialInstructions = string.Empty;
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: false);

            if (!string.IsNullOrEmpty(result.CheckoutUrl))
            {
                // Redirect to Stripe Checkout to pay (authorize now, capture when order Completed)
                NavigationManager.NavigateTo(result.CheckoutUrl, forceLoad: true);
                return;
            }

            if (!string.IsNullOrEmpty(result.Error))
            {
                // Order was placed but payment cannot be processed
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Order Placed - Payment Issue",
                    Detail = $"Your order #{result.OrderId.ToString().Substring(0, 8)} has been placed, but {result.Error} Please contact the vendor directly to complete payment."
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Order Placed",
                    Detail = $"Your order #{result.OrderId.ToString().Substring(0, 8)} has been placed successfully!"
                });
            }

            await Task.Delay(100);
            NavigationManager.NavigateTo("/orders");
        }
        catch (HttpRequestException ex)
        {
            // Handle BadRequest (400) - vendor not set up for payments
            Console.WriteLine($"Order blocked: {ex.Message}");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Cannot Place Order",
                Detail = ex.Message
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Order Failed",
                Detail = $"Failed to place order: {ex.Message}"
            });
        }
        finally
        {
            placingOrder = false;
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/restaurants");
    }

    private class PaymentReadyResponse
    {
        public Guid RestaurantId { get; set; }
        public bool PaymentReady { get; set; }
    }
}
