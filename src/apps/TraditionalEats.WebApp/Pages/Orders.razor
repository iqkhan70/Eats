@page "/orders"
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Orders - TraditionalEats</PageTitle>

<RadzenStack Gap="1.5rem" Style="padding: 1rem; width: 100%; max-width: 100vw; box-sizing: border-box;"
    Class="page-container">
    <RadzenText TextStyle="TextStyle.H1">My Orders</RadzenText>

    @if (loading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else if (orders.Any())
    {
        <RadzenStack Gap="1rem">
            @foreach (var order in orders)
            {
                <RadzenCard>
                    <RadzenStack Gap="1rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween"
                            AlignItems="AlignItems.Center">
                            <RadzenStack Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.H4" Style="font-weight: bold;">
                                    Order #@order.OrderId.ToString().Substring(0, 8)
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                                    @order.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                                </RadzenText>
                            </RadzenStack>
                            <RadzenBadge Text="@order.Status" Style="@GetStatusStyle(order.Status)" />
                        </RadzenStack>

                        <hr style="border: none; border-top: 1px solid var(--rz-border-color); margin: 0.5rem 0;" />

                        <RadzenStack Gap="0.5rem">
                            @if (order.Items.Count <= 3)
                            {
                                @foreach (var item in order.Items)
                                {
                                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                        <RadzenText TextStyle="TextStyle.Body1">
                                            @item.Name x @item.Quantity
                                        </RadzenText>
                                        <RadzenText TextStyle="TextStyle.Body1">
                                            $@item.TotalPrice.ToString("F2")
                                        </RadzenText>
                                    </RadzenStack>
                                }
                            }
                            else
                            {
                                @foreach (var item in order.Items.Take(2))
                                {
                                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                        <RadzenText TextStyle="TextStyle.Body1">
                                            @item.Name x @item.Quantity
                                        </RadzenText>
                                        <RadzenText TextStyle="TextStyle.Body1">
                                            $@item.TotalPrice.ToString("F2")
                                        </RadzenText>
                                    </RadzenStack>
                                }
                                <RadzenText TextStyle="TextStyle.Body2"
                                    Style="color: var(--rz-text-secondary-color); font-style: italic;">
                                    +@(order.Items.Count - 2) more items
                                </RadzenText>
                            }
                        </RadzenStack>

                        <hr style="border: none; border-top: 1px solid var(--rz-border-color); margin: 0.5rem 0;" />

                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween"
                            AlignItems="AlignItems.Center">
                            <RadzenText TextStyle="TextStyle.H4" Style="font-weight: bold;">Total</RadzenText>
                            <RadzenText TextStyle="TextStyle.H4" Style="font-weight: bold; color: var(--rz-primary);">
                                $@order.Total.ToString("F2")
                            </RadzenText>
                        </RadzenStack>

                        <RadzenButton Text="View Details" Icon="info" Click="@(() => ViewOrderDetails(order.OrderId))"
                            Variant="Variant.Flat" Size="ButtonSize.Small" />
                    </RadzenStack>
                </RadzenCard>
            }
        </RadzenStack>
    }
    else
    {
        <RadzenCard>
            <RadzenStack Gap="1rem" Style="align-items: center; padding: 2rem;">
                <RadzenIcon Icon="receipt" Style="font-size: 64px; color: var(--rz-text-secondary-color);" />
                <RadzenText TextStyle="TextStyle.H3">No orders yet</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Style="color: var(--rz-text-secondary-color);">
                    Start ordering to see your order history here
                </RadzenText>
                <RadzenButton Text="Browse Restaurants" Icon="restaurant"
                    Click="@(() => NavigationManager.NavigateTo("/restaurants"))" Variant="Variant.Flat" />
            </RadzenStack>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private bool loading = true;
    private List<OrderDto> orders = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        try
        {
            loading = true;
            var response = await Http.GetFromJsonAsync<List<OrderDto>>("WebBff/orders");
            orders = response ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading orders: {ex.Message}");
            orders = new();
        }
        finally
        {
            loading = false;
        }
    }

    private void ViewOrderDetails(Guid orderId)
    {
        NavigationManager.NavigateTo($"/orders/{orderId}");
    }

    private string GetStatusStyle(string status)
    {
        return status switch
        {
            "Pending" => "background-color: #fff3cd; color: #856404;",
            "Confirmed" => "background-color: #d1ecf1; color: #0c5460;",
            "Preparing" => "background-color: #d4edda; color: #155724;",
            "Ready" => "background-color: #cce5ff; color: #004085;",
            "OutForDelivery" => "background-color: #e2e3e5; color: #383d41;",
            "Delivered" => "background-color: #d4edda; color: #155724;",
            "Cancelled" => "background-color: #f8d7da; color: #721c24;",
            _ => "background-color: #e9ecef; color: #495057;"
        };
    }

    public class OrderDto
    {
        public Guid OrderId { get; set; }
        public Guid CustomerId { get; set; }
        public Guid RestaurantId { get; set; }
        public decimal Subtotal { get; set; }
        public decimal Tax { get; set; }
        public decimal DeliveryFee { get; set; }
        public decimal Total { get; set; }
        public string Status { get; set; } = string.Empty;
        public string DeliveryAddress { get; set; } = string.Empty;
        public string SpecialInstructions { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
        public DateTime? DeliveredAt { get; set; }
        public List<OrderItemDto> Items { get; set; } = new();
    }

    public class OrderItemDto
    {
        public Guid OrderItemId { get; set; }
        public Guid MenuItemId { get; set; }
        public string Name { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
        public decimal TotalPrice { get; set; }
    }
}
