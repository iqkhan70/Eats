@inherits LayoutComponentBase
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components
@using TraditionalEats.WebApp.Services
@inject AuthService AuthService

<RadzenLayout>
    <RadzenHeader>
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Gap="0px" Style="width: 100%; padding: 0.75rem 1rem;">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Center">
                <RadzenIcon Icon="restaurant_menu" Style="font-size: 24px;" />
                <RadzenText TextStyle="TextStyle.H4" Style="font-weight: bold;">TraditionalEats</RadzenText>
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" Class="desktop-nav">
                <RadzenButton Text="Home" Click="@(() => NavigationManager.NavigateTo("/"))" Variant="Variant.Flat" Size="ButtonSize.Small" />
                <RadzenButton Text="Restaurants" Click="@(() => NavigationManager.NavigateTo("/restaurants"))" Variant="Variant.Flat" Size="ButtonSize.Small" />
                @if (isAuthenticated)
                {
                    <RadzenButton Text="Orders" Click="@(() => NavigationManager.NavigateTo("/orders"))" Variant="Variant.Flat" Size="ButtonSize.Small" />
                    <RadzenButton Text="Profile" Click="@(() => NavigationManager.NavigateTo("/profile"))" Variant="Variant.Flat" Size="ButtonSize.Small" />
                    <RadzenButton Text="Logout" Icon="logout" Click="@HandleLogout" Variant="Variant.Flat" Size="ButtonSize.Small" />
                }
                else
                {
                    <RadzenButton Text="Login" Click="@(() => NavigationManager.NavigateTo("/login"))" Variant="Variant.Flat" Size="ButtonSize.Small" />
                    <RadzenButton Text="Register" Click="@(() => NavigationManager.NavigateTo("/register"))" Variant="Variant.Outlined" Size="ButtonSize.Small" />
                }
            </RadzenStack>
            <RadzenButton Icon="menu" Click="@(() => ToggleSidebar())" Variant="Variant.Flat" Size="ButtonSize.Small" Class="mobile-menu-btn" Style="display: none;" />
        </RadzenStack>
    </RadzenHeader>
    <RadzenBody>
        <RadzenContentContainer Name="main" Style="width: 100%; max-width: 100vw; padding: 0;">
            @Body
        </RadzenContentContainer>
    </RadzenBody>
    <RadzenSidebar @bind-Expanded="@sidebarExpanded">
        <RadzenPanelMenu>
            <RadzenPanelMenuItem Text="Home" Icon="home" Path="/" />
            <RadzenPanelMenuItem Text="Restaurants" Icon="restaurant" Path="/restaurants" />
            <RadzenPanelMenuItem Text="My Orders" Icon="receipt" Path="/orders" />
            <RadzenPanelMenuItem Text="Profile" Icon="account_circle" Path="/profile" />
        </RadzenPanelMenu>
    </RadzenSidebar>
</RadzenLayout>

@code {
    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;
    
    private bool sidebarExpanded = false;
    private bool isAuthenticated = false;

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthStatus();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckAuthStatus();
            StateHasChanged();
        }
    }

    private async Task CheckAuthStatus()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
    }

    private async Task HandleLogout()
    {
        await AuthService.ClearTokensAsync();
        isAuthenticated = false;
        NavigationManager.NavigateTo("/");
        StateHasChanged();
    }

    private void ToggleSidebar()
    {
        sidebarExpanded = !sidebarExpanded;
    }
}
